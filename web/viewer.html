<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>代码预览</title>
  <style>
    /* highlightjs-line-numbers.js 行号右对齐 */
    .hljs-ln-numbers {
      text-align: right;
      color: #bbb;
      user-select: none;
      background: transparent;
      border-right: 1px solid #eee;
      padding-right: 0.5em;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    body { font-family: monospace; margin: 2em; }
    .file { color: #2a7ae2; font-size: 1.1em; }
    .line { color: #888; }
    .code { background: #f8f8f8; padding: 0; border-radius: 6px; overflow-x: auto; white-space: pre; font-family: 'Fira Mono', 'Menlo', 'Consolas', 'monospace'; margin: 0; }
    .code pre { margin: 0; }
    .code code { margin: 0; display: block; padding: 0; }
    .highlight { background: #ffe066; color: #222; }
    .ln { display: inline-block; width: 3em; text-align: right; color: #bbb; margin-right: 1em; }
</style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/default.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/dart.min.js"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/java.min.js"></script> -->
  <script>
    // hljs.registerLanguage('dart', window.hljsDefineDart);
    // hljs.registerLanguage('javascript', window.hljsDefineJavascript);
    // hljs.registerLanguage('typescript', window.hljsDefineTypescript);
    // hljs.registerLanguage('python', window.hljsDefinePython);
    // hljs.registerLanguage('java', window.hljsDefineJava);
  </script>
</head>
<body>
  <div class="file" id="file"></div>
  <div class="code"><pre><code id="code" class=""></code></pre></div>
  <script>
    // 获取 url 参数
    function getQuery(name) {
      const m = location.search.match(new RegExp('(?:[?&]' + name + '=)([^&]+)'));
      return m ? decodeURIComponent(m[1]) : '';
    }
    function getLangByExt(file) {
      const ext = file.split('.').pop().toLowerCase();
      if (ext === 'js') return 'javascript';
      if (ext === 'ts') return 'typescript';
      if (ext === 'py') return 'python';
      if (ext === 'java') return 'java';
      if (ext === 'dart') return 'dart';
      return '';
    }
    const file = getQuery('file');
    const line = parseInt(getQuery('line'), 10);
    document.getElementById('file').textContent = file + (line ? ' : ' + line : '');
    const lang = getLangByExt(file);
    const codeEl = document.getElementById('code');
    if (lang) codeEl.className = 'language-' + lang;
    fetch('/api/file?file=' + encodeURIComponent(file)).then(r => r.json()).then(data => {
      if (!data.lines) { codeEl.textContent = '无法读取文件'; return; }
      // 先移除所有 class，避免 className 累加
      codeEl.className = '';
      codeEl.textContent = data.lines.join('\n');
      // 设置 class 以兼容行号插件
      if (lang) codeEl.className = 'hljs language-' + lang;
      else codeEl.className = 'hljs';
      // 先高亮再加行号
      if (window.hljs) hljs.highlightElement(codeEl);
      setTimeout(() => {
        if (window.hljs && window.hljs.lineNumbersBlock) hljs.lineNumbersBlock(codeEl);
        // 高亮指定行
        if (line) {
          const lines = codeEl.querySelectorAll('.hljs-ln-code');
          if (lines[line-1]) {
            lines[line-1].style.background = '#ffe066';
            lines[line-1].style.color = '#222';
            lines[line-1].scrollIntoView({behavior:'smooth',block:'center'});
          }
        }
      }, 0);
    });
  </script>
</body>
</html>
