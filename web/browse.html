<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>é¡¹ç›®ç›®å½•æµè§ˆ</title>
  <link rel="stylesheet" href="common.css">
  <style>
    /* body æ ·å¼ç§»è‡³ common.css */
    a {
      color: #2a7ae2;
      text-decoration: none;
      transition: color 0.15s;
    }
    a:hover {
      text-decoration: underline;
      color: #1558b0;
    }
    ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    .dir {
      font-weight: bold;
      color: #1558b0;
      background: #eaf2fb;
      border-radius: 5px;
      padding: 0.3em 0.7em;
      margin-bottom: 0.18em;
      display: flex;
      align-items: center;
    }
    .file {
      color: #444;
      background: #fff;
      border-radius: 5px;
      padding: 0.3em 0.7em;
      margin-bottom: 0.18em;
      display: flex;
      align-items: center;
    }
    .breadcrumb {
      font-size: 1.08em;
      /* background: #f0f4f8; */
      border-radius: 5px;
      padding: 0.5em 1em;
      color: #1558b0;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
    }
    .breadcrumb a {
      color: #2a7ae2;
      font-weight: bold;
      margin: 0 0.1em;
    }
    .breadcrumb a:hover {
      color: #1558b0;
    }
    .breadcrumb span {
      color: #888;
      margin: 0 0.1em;
    }
    .icon {
      margin-right: 0.5em;
      font-size: 1.1em;
      vertical-align: middle;
    }
    @media (max-width: 600px) {
      body { margin: 0.5em; }
      .breadcrumb { font-size: 0.98em; padding: 0.4em 0.5em; }
      .dir, .file { padding: 0.2em 0.4em; font-size: 0.98em; }
    }
  </style>
</head>
<body class="page-root">
  <div class="page-header breadcrumb" id="breadcrumb"></div>
  <table id="file-table" style="width:100%;border-collapse:separate;border-spacing:0;"></table>
  <script>
    function getQuery(name) {
      const m = location.search.match(new RegExp('(?:[?&]' + name + '=)([^&]+)'));
      return m ? decodeURIComponent(m[1]) : '';
    }
    const project = getQuery('project');
    const relative = getQuery('relative');

    // è·¯å¾„æ ¼å¼é¢åŒ…å±‘å¯¼èˆª
    function renderBreadcrumb() {
      if (!project) return;
      let html = `<a href="index.html" style="margin-right: 0.5em;">Home</a> &gt; <a href="browse.html?project=${encodeURIComponent(project)}" style="margin-left: 0.5em;">${project}</a>`;
      if (relative) {
        let parts = relative.split('/');
        let path = '';
        for (let i = 0; i < parts.length; i++) {
          path += (i > 0 ? '/' : '') + parts[i];
          html += `/<a href="browse.html?project=${encodeURIComponent(project)}&relative=${encodeURIComponent(path)}">${parts[i]}</a>`;
        }
      }
      document.getElementById('breadcrumb').innerHTML = html;
    }
    renderBreadcrumb();

    // è·å–ç›®å½•å†…å®¹
    fetch(`/api/list?project=${encodeURIComponent(project)}&relative=${encodeURIComponent(relative||'')}`)
      .then(r=>r.json())
      .then(data=>{
        const table = document.getElementById('file-table');
        if (!data || !Array.isArray(data.entries)) {
          table.innerHTML = '<tr><td>æ— æ³•è·å–ç›®å½•å†…å®¹</td></tr>';
          return;
        }
        if (data.entries.length === 0) {
          table.innerHTML = '<tr><td>ç›®å½•ä¸ºç©º</td></tr>';
          return;
        }
        // è¡¨å¤´
        table.innerHTML = `<tr style="background:#e0e3e8;font-weight:bold;"><td style="padding:0.5em 0.7em;">åç§°</td><td style="padding:0.5em 0.7em;">ç±»å‹</td><td style="padding:0.5em 0.7em;">Size</td><td style="padding:0.5em 0.7em;">Date</td></tr>` +
          data.entries.map((e, i) => {
            const isDir = e.type === 'dir';
            const rowBg = i % 2 === 0 ? '#f8f8fa' : '#eaf2fb';
            let size = e.size !== undefined ? (isDir ? '-' : formatSize(e.size)) : '-';
            let date = e.mtime ? new Date(e.mtime).toLocaleString() : '-';
            let nameHtml = isDir
              ? `<span class="icon">ğŸ“</span><a href="browse.html?project=${encodeURIComponent(project)}&relative=${encodeURIComponent(e.relative)}">${e.name}</a>`
              : `<span class="icon">ğŸ“„</span><a href="viewer.html?project=${encodeURIComponent(project)}&relative=${encodeURIComponent(e.relative)}">${e.name}</a>`;
            return `<tr style="background:${rowBg};"><td style="padding:0.3em 0.7em;">${nameHtml}</td><td style="padding:0.3em 0.7em;">${isDir ? 'ç›®å½•' : 'æ–‡ä»¶'}</td><td style="padding:0.3em 0.7em;">${size}</td><td style="padding:0.3em 0.7em;">${date}</td></tr>`;
          }).join('');
      });

    // æ–‡ä»¶å¤§å°æ ¼å¼åŒ–
    function formatSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
      if (bytes < 1024*1024*1024) return (bytes/1024/1024).toFixed(1) + ' MB';
      return (bytes/1024/1024/1024).toFixed(1) + ' GB';
    }
  </script>
</body>
</html>
