<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>本地代码搜索</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    input, button { font-size: 1em; }
    .result { margin: 1em 0; padding: 0.5em; border-bottom: 1px solid #eee; }
    mark { background: #ffe066; color: #222; }
    .file { color: #2a7ae2; }
    .line { color: #888; }
    .content { font-family: monospace; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>本地代码搜索</h1>
  <form id="searchForm">
    <input type="text" id="keyword" placeholder="输入关键词" required />
    <input type="text" id="dir" placeholder="搜索目录（可选）" style="width: 18em;" />
    <button type="submit">搜索</button>
  </form>
  <div id="results"></div>
  <script>
    const form = document.getElementById('searchForm');
    const resultsDiv = document.getElementById('results');
    let lastQuery = {};
    let currentPage = 1;
    let totalPages = 1;
    const pageSize = 20;

    async function doSearch(page = 1) {
      resultsDiv.innerHTML = '搜索中...';
      const keyword = document.getElementById('keyword').value.trim();
      const dir = document.getElementById('dir').value.trim();
      lastQuery = { keyword, dir };
      const res = await fetch('/api/search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ keyword, dir, page, pageSize })
      });
      const { total, data } = await res.json();
      if (!total) {
        resultsDiv.innerHTML = '<p>未找到匹配项。</p>';
        return;
      }
      totalPages = Math.ceil(total / pageSize);
      currentPage = page;
      resultsDiv.innerHTML = data.map(r => `
        <div class="result">
          <a href="viewer.html?file=${encodeURIComponent(r.file)}&line=${r.line}" target="_blank">
            <span class="file">${r.file}</span> : <span class="line">${r.line}</span>
          </a><br>
          <span class="content">${r.content}</span>
        </div>
      `).join('');
      // 分页控件
      resultsDiv.innerHTML += `<div style="margin:1em 0;">
        <button id="prevPage" ${currentPage===1?'disabled':''}>上一页</button>
        <span>第 ${currentPage} / ${totalPages} 页</span>
        <button id="nextPage" ${currentPage===totalPages?'disabled':''}>下一页</button>
        跳转到 <input id="gotoPage" type="number" min="1" max="${totalPages}" value="${currentPage}" style="width:3em;"> 页
        <button id="goBtn">Go</button>
      </div>`;
      document.getElementById('prevPage').onclick = () => doSearch(currentPage-1);
      document.getElementById('nextPage').onclick = () => doSearch(currentPage+1);
      document.getElementById('goBtn').onclick = () => {
        const val = parseInt(document.getElementById('gotoPage').value, 10);
        if (val>=1 && val<=totalPages) doSearch(val);
      };
    }

    form.onsubmit = (e) => {
      e.preventDefault();
      doSearch(1);
    };
  </script>
</body>
</html>
